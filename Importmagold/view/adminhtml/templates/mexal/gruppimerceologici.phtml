<?php

//$response = $block->getApiGruppiMerceologiciResponse();
//$response_associativa = $block->getArrayRispostaGruppiMerceologiciRielaborati();

// Decodifica il JSON per assicurarti che sia un array o oggetto PHP
//$responseData = json_decode($response, true);

// Ricodifica il JSON in formato leggibile con indentazione
//$prettyResponse = json_encode($responseData, JSON_PRETTY_PRINT);
?>

<h1>Risultato della Chiamata Gruppi Merceologici</h1>
<div>
    <pre>
    	<?php echo $block->getData('output'); ?>
    	<?php print_r($block->getData('response_associativa')); ?>
    	<?php //echo htmlspecialchars($prettyResponse, ENT_QUOTES, 'UTF-8'); ?>
    </pre>
</div>




<?php

$response = $block->getApiGruppiMerceologiciResponse();

// Decodifica il JSON per assicurarti che sia un array PHP
$responseData = json_decode($response, true);

// Crea una struttura ad albero dai dati
$tree = [];
$lookup = [];

// Costruisci un array di lookup per i nodi
foreach ($responseData['dati'] as $category) {
    $lookup[$category['codice']] = $category;
    $lookup[$category['codice']]['children'] = [];
}

// Costruisci l'albero delle categorie
foreach ($lookup as $codice => &$category) {
    if (!empty($category['cod_grp_merc'])) {
        // Se la categoria ha un genitore, aggiungila ai figli del genitore
        $lookup[$category['cod_grp_merc']]['children'][] = &$category;
    } else {
        // Se non ha un genitore, Ã¨ una categoria principale
        $tree[] = &$category;
    }
}

unset($category); // Rompi il riferimento

// Funzione per stampare l'albero delle categorie in HTML
function printCategoryTree($categories, $level = 0)
{
    if (empty($categories)) {
        return;
    }

    echo '<ul style="list-style-type: none;">';
    foreach ($categories as $category) {
        $style = '';
        switch ($level) {
            case 0:
                $style = 'font-weight: bold; color: darkblue;';
                break;
            case 1:
                $style = 'font-weight: bold; color: darkgreen;';
                break;
            case 2:
                $style = 'color: darkred;';
                break;
            default:
                $style = 'color: black;';
                break;
        }

        echo '<li style="' . $style . '">';
        echo str_repeat('&nbsp;', $level * 4) . htmlspecialchars($category['descrizione'], ENT_QUOTES, 'UTF-8');
        echo ' (Stato: ' . htmlspecialchars($category['stato'], ENT_QUOTES, 'UTF-8') . ', Livello: ' . ($level + 1) . ', cod_grp_merc: ' . $category['cod_grp_merc'] . ', codice: ' . $category['codice'] . ')';
        printCategoryTree($category['children'], $level + 1);
        echo '</li>';
    }
    echo '</ul>';
}
?>

<h1>Risultato della Chiamata Gruppi Merceologici</h1>
<div>
    <?php printCategoryTree($tree); ?>
</div>

